---  
- hosts: all
  become: true
  pre_tasks:

  - name: Update and upgrade apt packages
    tags: always
    ansible.builtin.apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 #One day
    # when: ansible_distribution_family == "Debian"

  - name: Check if a reboot is needed
    register: reboot_required_file
    stat: path=/var/run/reboot-required get_md5=no

  - name: Remove useless packages from the cache
    ansible.builtin.apt:
      autoclean: yes
    # when: ansible_distribution_family == "Debian"

  - name: Remove dependencies that are no longer required
    ansible.builtin.apt:
      autoremove: yes
    # when: ansible_distribution_family == "Debian"

  - name: Reboot if kernel updated
    reboot:
      msg: "Reboot initiated by Ansible for kernel updates"
      connect_timeout: 5
      reboot_timeout: 300
      pre_reboot_delay: 0
      post_reboot_delay: 30
      test_command: uptime
    when: reboot_required_file.stat.exists

  - name: create fuzoide user
    tags: always
    user:
      name: fuzoide
      groups: root

  - name: add ssh key for fuzoide
    tags: always
    ansible.posix.authorized_key:
      user: fuzoide
      state: present
      # key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJt2CJlUCBNaiZWlBkelSeW6aQtqJ/pSrZMc+ZPj6WLt ansible"
      key: "{{ lookup('file', '/home/skmecs/.ssh/ansible.pub') }}"

  - name: add sudoers file for fuzoide
    tags: always
    copy:
      src: sudoer_fuzoide
      dest: /etc/sudoers.d/fuzoide
      owner: root
      group: root
      mode: 0440
